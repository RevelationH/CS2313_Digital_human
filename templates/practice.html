{% extends 'base.html' %}

{% block content %}
<style>
  :root{--bg:#0b1020;--card:#121932;--muted:#9aa3b2;--text:#e7ecf3;--primary:#6c7cff;--primary-600:#5768ff;--accent:#22d3ee;--ring:0 0 0 3px rgba(108,124,255,.25);--radius:16px;--shadow-lg:0 10px 30px rgba(0,0,0,.35);--shadow-md:0 12px 24px rgba(16,24,40,.25)}
  @media(prefers-color-scheme:light){:root{--bg:#f6f7fb;--card:#fff;--muted:#64748b;--text:#0f172a;--primary:#4f46e5;--primary-600:#4338ca;--accent:#0891b2;--ring:0 0 0 4px rgba(79,70,229,.18);--shadow-lg:0 20px 40px rgba(2,6,23,.15);--shadow-md:0 12px 24px rgba(2,6,23,.1)}}
  body{background:var(--bg)}
  .wrap{max-width:1100px;margin:40px auto;padding:0 20px;color:var(--text)}
  .hero{border-radius:calc(var(--radius) + 6px);background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;padding:28px;box-shadow:var(--shadow-lg)}
  .hero h2{margin:0;font-size:28px}
  .hero .meta{opacity:.9;font-size:14px;margin-top:6px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow-md);padding:20px}
  .card + .card{margin-top:16px}

  .stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:8px}
  .stat{border:1px solid rgba(148,163,184,.22);border-radius:14px;padding:14px;background:rgba(255,255,255,.03)}
  .muted{color:var(--muted)}

  .q-list{display:grid;gap:12px;margin-top:12px}
  .q-item{border:1px solid rgba(148,163,184,.22);border-radius:14px;padding:14px;background:rgba(255,255,255,.03);display:grid;gap:10px}
  .q-title{font-weight:700;line-height:1.45}

  .choices{display:grid;gap:8px;margin-top:6px}
  .choice{display:flex;gap:10px;align-items:flex-start;border:1px solid rgba(148,163,184,.28);border-radius:10px;padding:10px;background:rgba(255,255,255,.04);cursor:pointer}
  .choice:hover{border-color:var(--primary)}
  .choice input{margin-top:3px}

  .q-text{width:100%;border-radius:10px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid rgba(148,163,184,.28);padding:10px 12px;transition:box-shadow .15s ease,border-color .15s ease,background .2s ease;resize:vertical;min-height:60px}
  .q-text:focus{outline:none;border-color:var(--primary);box-shadow:var(--ring);background:rgba(255,255,255,.06)}

  .result{display:grid;gap:6px;border:1px solid rgba(148,163,184,.2);border-radius:10px;padding:10px;background:rgba(255,255,255,.04)}
  .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:600;font-size:12px}
  .ok{color:#22c55e;border-color:rgba(34,197,94,.35)}
  .bad{color:#ef4444;border-color:rgba(239,68,68,.35)}

  .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;transition:transform .02s ease,box-shadow .2s ease,background .2s ease}
  .btn:active{transform:translateY(1px)}
  .btn-p{background:var(--primary);color:#fff;box-shadow:0 8px 20px rgba(79,70,229,.35)}
  .btn-p:hover{background:var(--primary-600)}
  .btn-s{background:transparent;color:var(--text);border:1px solid rgba(148,163,184,.35)}
</style>

<div class="wrap" aria-labelledby="page-title">
  <div class="hero">
    <h2 id="page-title">Practice for "{{ kp_name }}"</h2>
    <div class="meta">Click to select an option. After you submit, you'll see correctness and explanations.</div>
  </div>

  {% if summary %}
  <div class="card" role="region" aria-label="Submission summary">
    <h3 style="margin:0 0 8px 0;">Submission Summary</h3>
    <div class="stats">
      <div class="stat"><div class="muted">Answered</div><div style="font-size:22px;font-weight:700;">{{ summary.answered }}</div></div>
      <div class="stat"><div class="muted">Correct</div><div style="font-size:22px;font-weight:700;">{{ summary.correct }}</div></div>
      <div class="stat"><div class="muted">Incorrect</div><div style="font-size:22px;font-weight:700;">{{ summary.incorrect }}</div></div>
      <div class="stat"><div class="muted">Accuracy</div><div style="font-size:22px;font-weight:700;">{{ (100*summary.correct/summary.answered)|round(1) if summary.answered else 0 }}%</div></div>
    </div>
  </div>
  {% endif %}

  <div class="card" role="region" aria-label="Practice questions">
    <form method="POST" id="practice-form">
      <ul class="q-list">
        {% for q in questions %}
        {% set field_name = 'user_answer_' ~ q['question'] %}
        {% set r = (results_map.get(q['question']) if results_map else none) %}
        {% set parsed = q.options if q.options else (q['question'] | extract_mcq_options) %}
        <li class="q-item">
            <div class="q-title">{{ q['question'] | mcq_html }}</div>


          {% if parsed and parsed|length > 0 %}
            <div class="choices">
              {% for label, text in parsed %}
              {# 单选的 value 直接用 A/B/C/D，后端已有 _pick_mcq 会识别 #}
              <label class="choice">
                <input type="radio"
                       name="{{ field_name }}"
                       value="{{ label }}"
                       {% if r and r.user_answer and r.user_answer|string|upper == label|string|upper %}checked{% endif %}
                       aria-label="Option {{ label }}">
                <div><b>{{ label }}.</b> {{ text }}</div>
              </label>
              {% endfor %}
            </div>
          {% else %}
            {# 解析不到选项：回退为文本输入 #}
            <textarea class="q-text" name="{{ field_name }}" placeholder="Your answer here">{{ (r.user_answer if r else '') }}</textarea>
          {% endif %}

          {% if r %}
          <div class="result" aria-live="polite">
            <div>
              {% if r.is_correct %}<span class="tag ok">✓ Correct</span>{% else %}<span class="tag bad">✗ Incorrect</span>{% endif %}
            </div>
            <div><b>Correct answer:</b> {{ r.std_answer }}</div>
            {% if r.explanation %}<div><b>Explanation:</b> {{ r.explanation }}</div>{% endif %}
          </div>
          {% endif %}
        </li>
        {% endfor %}
      </ul>

      <div class="toolbar" style="margin-top:12px;">
        <button type="submit" class="btn btn-p" id="submit-btn">Submit Answers</button>
        <a class="btn btn-s" href="{{ url_for('dashboard') }}">Back to Dashboard</a>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('practice-form');
  const submit = document.getElementById('submit-btn');
  form?.addEventListener('submit', function(){
    submit.disabled = true; submit.style.opacity=.85; submit.textContent='Submitting…';
  });
})();
</script>
{% endblock %}
