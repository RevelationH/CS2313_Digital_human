{% extends 'base.html' %}
{% block content %}
<h2>{{ username }}'s Learning Analysis</h2>
<table border="1">
    <tr>
        <th>Knowledge Point</th><th>Wrong Questions</th>
    </tr>
    {% for kp, stat in kp_stats.items() %}
        <tr>
            <td>{{ kp }}</td>
            <td>{{ stat.wrong }}</td>  <!-- 显示错题数量 -->
        </tr>
    {% endfor %}
</table>

<h3>Weak Knowledge Points: </h3>
<ul>
    {% for weak_point in weak_points %}
        <li>{{ weak_point }}</li>
    {% endfor %}
</ul>
<!-- <p>
    <button id="personalized-btn">AI Personalized Practice & Analysis</button>
    <button id="ai-wrong-btn" style="margin-left:20px;">AI Personalized Wrong Question Practice</button>
</p> -->
<div id="analysis-result" style="margin-top:1em;color:#222;font-size:1.1em"></div>
<div id="ai-wrong-quiz" style="margin-top:1em;"></div>
<div id="ai-wrong-result" style="margin-top:1em;color:#222;font-size:1.1em"></div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
$('#personalized-btn').click(function() {
    $("#personalized-btn").prop("disabled", true).text("Analyzing...");
    $.ajax({
        url: "/api/deepseek_analysis",
        type: "POST",
        contentType: "application/json",
        success: function(data) {
            let html = "<b>AI Analysis & Personalized Recommendation:</b><br>" + data.analysis.replace(/\n/g, "<br>");
            if (data.questions_ai && data.questions_ai.length > 0) {
                html += "<hr><b>AI Recommended New Questions:</b><ul>";
                for(let i=0; i<data.questions_ai.length; i++) {
                    html += "<li>"+data.questions_ai[i]+"</li>";
                }
                html += "</ul>";
            }
            $("#analysis-result").html(html);
            $("#personalized-btn").prop("disabled", false).text("AI Personalized Practice & Analysis");
        },
        error: function(err) {
            alert("Analysis failed: " + (err.responseJSON && err.responseJSON.error));
            $("#personalized-btn").prop("disabled", false).text("AI Personalized Practice & Analysis");
        }
    });
});


$('#ai-wrong-btn').click(function() {
    $("#ai-wrong-btn").prop("disabled", true).text("Generating...");
    $.ajax({
        url: "/api/ai_wrong_practice",
        type: "POST",
        contentType: "application/json",
        success: function(data) {
            if (data.questions_ai && data.questions_ai.length > 0) {
                let html = '<form id="ai-quiz-form"><ul style="padding-left:18px;">';
                for (let i = 0; i < data.questions_ai.length; i++) {
                    const qobj = data.questions_ai[i];

                    // 安全转义（避免把 AI 文本直接插入 HTML）
                    const escQ  = $('<div/>').text(qobj.question || '').html();
                    const escA  = $('<div/>').text(qobj.answer || '').html();
                    const escKP = $('<div/>').text(qobj.knowledge_point || '').html();
                    const escExp= $('<div/>').text(qobj.explanation || '').html();

                    html += '<li style="margin-bottom:14px;">' +
                        '<div><b>[' + escKP + ']</b></div>' +
                        // 题干+选项里可能有换行，保持格式
                        '<div style="white-space:pre-line;margin-top:4px;">' + escQ + '</div>';

                    // 若有解析，展示（作为提示，不影响作答）
                    if (qobj.explanation) {
                        html += '<div style="margin-top:6px;color:#666;"><i>Explanation (AI hint): </i>' + escExp + '</div>';
                    }

                    // 隐藏字段：提交给 /api/submit_ai_practice 使用
                    html += '<input type="hidden" name="question_' + i + '" value="' + escQ + '">' +
                            '<input type="hidden" name="answer_'   + i + '" value="' + escA + '">' +
                            '<input type="hidden" name="knowledge_point_' + i + '" value="' + escKP + '">' +
                            '<input type="hidden" name="explanation_' + i + '" value="' + escExp + '">' +

                            // 作答输入
                            '<input name="user_answer_' + i + '" required ' +
                            'placeholder="Your answer (A/B/C/D)" ' +
                            'style="margin-top:8px;width:200px;">' +
                        '</li>';
                }
                html += '</ul><button type="submit">Submit Answers</button></form>';

                $("#ai-wrong-quiz").html(html);
                $("#ai-wrong-result").html('');
            } else {
                $("#ai-wrong-quiz").html("<b>No new unique questions generated by AI.</b>");
                $("#ai-wrong-result").html('');

                if (data && data.raw) {
                    $("#ai-wrong-result").append(
                        "<div style='margin-top:8px'><i>AI raw output:</i><pre style='white-space:pre-wrap;'>" +
                        $('<div/>').text(data.raw).html() + "</pre></div>"
                    );
                }
            }
            $("#ai-wrong-btn").prop("disabled", false).text("AI Personalized Wrong Question Practice");
        },
        error: function(err) {
            alert("Generation failed: " + (err.responseJSON && err.responseJSON.error));
            $("#ai-wrong-btn").prop("disabled", false).text("AI Personalized Wrong Question Practice");
        }
    });
});

// AI题目练习答案提交
$(document).on('submit', '#ai-quiz-form', function(e) {
    e.preventDefault();
    let form = $(this);
    let answers = [];
    let count = form.find('input[name^="question_"]').length;
    for(let i=0; i<count; i++) {
        answers.push({
            question: form.find('input[name="question_'+i+'"]').val(),
            answer: form.find('input[name="answer_'+i+'"]').val(),
            user_answer: form.find('input[name="user_answer_'+i+'"]').val(),
            knowledge_point: form.find('input[name="knowledge_point_'+i+'"]').val()
        });
    }
    $.ajax({
        url: "/api/submit_ai_practice",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({answers: answers}),
        success: function(data) {
            let html = "<b>Result:</b><ul>";
            data.results.forEach(function(r, idx){
                html += "<li style='margin-bottom:10px;'>" + r.question + "<br>Your answer: <b>" + r.your_answer + "</b>";
                if(r.is_correct){
                    html += " ✅";
                } else {
                    html += " ❌<br>Correct answer: <b>" + r.correct_answer + "</b>";
                }
                html += "</li>";
            });
            html += "</ul><div style='color:green;'>All your answers have been saved. Wrong answers will be added to your wrong question book.</div>";
            $("#ai-wrong-result").html(html);
            $("#ai-wrong-quiz").html('');
        },
        error: function() {
            alert("Submit failed");
        }
    });
});
</script>
<p><a href="{{ url_for('dashboard') }}">Back</a></p>
{% endblock %}
