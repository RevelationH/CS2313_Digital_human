{% extends 'base.html' %}

{% block content %}
<h2>Knowledge Point Management</h2>

<p>
    <a href="{{ url_for('admin_kp_import') }}"><b>➕ Generate Knowledge Points from Course Materials (Kimi)</b></a>
</p>

<!-- ── Add a new Knowledge Point ─────────────────────────────────────────── -->
<form method="post" action="{{ url_for('admin_kp_add') }}"
      style="margin-bottom:20px;">
    <input name="kp_name"
           placeholder="New Knowledge Point Name"
           required>

    <!-- ① 选择现有 list（默认第一个） -->
    <select name="list_id">
        {% for lid in lists %}
            <option value="{{ lid }}">{{ lid }}</option>
        {% endfor %}
        <option value="">— new list —</option>
    </select>

    <!-- ② 如果要建新 list，请在下框输入；否则可留空 -->
    <input name="custom_list_id"
           placeholder="If new list, type it here">

    <button type="submit">Add</button>
</form>

<!-- ── Grouped catalogue view ────────────────────────────────────────────── -->
{% set grouped = kps | groupby('list_id') %}
{% for grp in grouped %}
  <details open style="margin-bottom:16px;">
    <summary style="font-weight:bold;cursor:pointer;">
      {{ grp.grouper or '(Uncategorized)' }}
    </summary>

    <ul>
      {% for kp in grp.list %}
        <li style="margin-bottom:10px;">
          <b>{{ kp.name }}</b><br>
          <i>{{ kp.description }}</i>

          {% if kp.questions %}
            <ul>
              {% for question in kp.questions %}
                <li>{{ question }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <div style="font-size:90%;color:#888;">— no questions —</div>
          {% endif %}

          <a href="{{ url_for('admin_questions',
                              list_id=kp.list_id,
                              kp_name=kp.name) }}">[Manage&nbsp;Questions]</a>

          <a href="{{ url_for('admin_kp_delete',
                              list_id=kp.list_id,
                              kp_name=kp.name) }}"
             onclick="return confirm('Delete this knowledge point and all its questions?');">[Delete]</a>
        </li>
      {% endfor %}
    </ul>
  </details>
{% endfor %}

<p><a href="{{ url_for('dashboard') }}">Back to User Dashboard</a></p>
{% endblock %}
